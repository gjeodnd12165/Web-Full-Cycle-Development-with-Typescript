### 이미지 레지스트리 작성
#### 인수 테스트 (UAT; User Acceptance Test)
- 요구 사항대로 기능이 구현되었는지를 확인하는 과정
    - 전체 시스템을 사용자 관점에서 시험하는 블랙박스 테스트 포함
- 이것을 자동화하는 것이 CI/CD 구축을 위해 반드시 필요
    - 전통적으로는 수작업에 의존
- 사용자 인수 테스트를 자동화하는 것을 어렵게 하는 요인들
    - 사용자 참여: 기술적 측면과 비기술적 측면에 대한 요구사항의 최종 확인은 실사용자여야 함
    - 의존성 통합: 테스트할 애플리케이션은 모든 의존성을 포함하여 이루어져야 함
    - 스테이징 환경: 프로덕션 환경과 동일한 스테이징 환경에서 이루어져야 함
    - 애플리케이션 동일성: 한 번만 빌드하여 프로덕션에서와 동일한 바이너리를 이용해야 함
    - 릴리스 준비: 인수 테스트를 통화한 애플리케이션은 즉시 릴리스할 준비가 되어야 함

#### 이 단원 강의의 흐름
- 도커 레지스트리 구성
    - 빌드한 이미지를 저장 및 관리할 수 있는 저장소 셋업
    - 다른 공개/상용 서비스를 이용할 수도 있으나, 공부가 목적
- 애플리케이션 패키지 빌드 및 이미지 푸시
    - 소스 수준에서 테스트가 완료된 애플리케이션을 독립 및 통일된 환경에서 실행될 수 있도록 컨테이너화
    - 응용 소프트웨어를 컨테이너에 포함하여 이미지로 만들고 레지스트리에 저장
- UAT 프레임워크 적용
    - 보다 체계적이고 완성도가 높은 인수 테스트를 위한 프레임워크 활용

#### 아티팩트 리포지토리
- 버전 관리, 접근 제어 등의 기능을 가지는 소프트웨어 개발 산출물을 발행하거나 인출할 수 있는 저장소 및 관리 기법이 필요
- 파이프라인의 모든 단계에서 동일한 바이너리가 사용되는 것을 보장함으로써 지속적 인도 프로세스에서 매우 중요한 역할을 함

#### 도커 레지스트리
- 컨테이너화된 소프트웨어의 산출물인 도커 이미지를 관리할 수 있는 레지스트리
- 클라우스 방식 레지스트리
    - Docker Hub
    - WAS ECR, GCP Artifact Restistry, Azure Container Registry
- 자체 호스팅 방식 레지스트리
    - 사내 네트워크가 아닌 외부에 소프트웨어를 보관하는 것을 금지하는 정책을 갖고 있는 경우에는 유일한 해결 방법

#### 이미지 레지스트리 구축 실습
- Docker 를 이용해서 로컬 컴퓨터의 컨테이너로 레지스트리 서비스 테스트
- k8s 클러스터에 레지스트리 서비스 배포
    - 기본 동작 테스트
    - OpenSSL 인증서 설치, 설정
    - PV와 PVC를 만들어 데이터가 호스트에 남아 있도록 설정
    - docker push와 kubectl run으로 기본적 확인, Jenkins 파이프라인에서의 테스트

#### 레지스트리 이미지
- Docker Hub에서 Registry 검색 후 공식적으로 제공하는 이미지 사용

#### 한 단계씩 확인
- 지금까지 확인
    - registry:2 이미지를 이용하여 도커 레지스트리를 운용할 수 있음
    - 두 개의 API endpoint를 이용하여 저장된 이미지의 목록과 각 이미지의 태그 목록을 조회할 수 있음
        - `<host url>/v2/_catalog`: 이미지 목록
        - `<host url>/v2/<image name>/tages/list`: 해당 이미지 태그 목록

#### 데이터 볼륨과 SSL 인증서
- 호스트의 디렉토리를 레지스트리에 볼륨으로 공유
    - 레지스트리에 저장된 데이터는 컨테이너 및 포드 등이 사멸하는 경우에도 유지할 수 있도록
    - 실제 개발 환경에서는 어딘가 저장 장소를 마련해 두고 주기적으로 백업하는 방법을 택할 것이나, 실습에서는 호스트의 파일 시스템 내 특정 위치에 데이터가 저장되도록 설정
    - PV를 정의하고 PVC를 설정하여 레지스트리 서버 컨테이너에서 이용하도록 볼륨 마운트
- 자가 서명된 인증서를 발급하여 레지스트리 서버에 설치
    - 실제 운용 환경에서는 ca로부터 발급받은 인증서를 사용할 것
    - 실습에서는 간이로 자가 서명 인증서를 발급하고 이것을 레지스트리 서버에 설치

#### 자가 서명 인증서 발급
- OpenSSL을 이용한 인증서 발급 및 설치
    - 우선 openssl 설치
    ```bash
    openssl req \
    -newkey rsa:4096 -nodes -sha256 -keyout certs/registry.key \
    -addext "subjectAltName = DNS:registry-service.registry.svc.cluster.local" \
    -x509 -days 3650 -out certs/registry.crt
    ```
    - k8s의 secret으로 등록
    ```bash
    kubectl create secret tls registry-cert \
    --cert=certs/registry.crt \
    --key=certs/registry.key \
    -n registry
    ```

#### 접근 제어
- 보통은 login id 와 password의 쌍으로 사용자 인증
    - 로그인하는 사용자에 따라 서로 다른 권한을 적용


>> https 설정부터 막혀서 이후 강의를 수행할 수 없음